<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="https://mozz.ie/">
    <title>新柏石KNX协议智能家居网关接入 HomeAssistant - 蚊帐</title>
    <meta name="description"
        content="只需要一根网线和一些小技巧，将开发商精装送的全屋智能设备接入HA，同时完整保留对原有系统的兼容，不具侵入性。">
    
    
    <meta name="author" content="mozzie">
    
    
    
    
    
    <link rel="stylesheet" href="/scss/style.min.96a20e69193e20e98b419c09023a453e83dc8f144843da3c6451726c3e3ff162.css">
    <link rel="icon" type="image/x-icon" href="/img/icon.png">
    <meta name="view-transition" content="same-origin">
    
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>

    
    <meta property="og:title" content="新柏石KNX协议智能家居网关接入 HomeAssistant" />
<meta property="og:description" content="只需要一根网线和一些小技巧，将开发商精装送的全屋智能设备接入HA，同时完整保留对原有系统的兼容，不具侵入性。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mozz.ie/posts/homeassistant-integration-writeup/" /><meta property="og:image" content="https://mozz.ie/assets/homeassistant-integration-writeup/photo_2025-03-22_01-05-25.jpg" />
<meta property="og:site_name" content="蚊帐" /><meta property="article:published_time" content="2025-03-22T00:00:00&#43;00:00" /><meta property="article:modified_time" content="2025-03-22T00:00:00&#43;00:00" />
<meta property="article:section" content="技术" />
    
</head>

<body>
    

<div class="container" id="container">
    <div class="bean bean-main">
    <div class="avatar">
        <img src="/img/icon.png" alt="蚊帐">
    </div>
    <div class="blog-name">蚊帐</div>
    <div class="links">
        <a class="link-item " href="/">
            <div class="link-container">
                <span class="link-icon"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24"><g fill="none"><path d="M7.5 2.75a.75.75 0 0 0-1.5 0v3a1.75 1.75 0 0 0 1.543 1.738L6.527 9.993a3.868 3.868 0 0 0 .119 3.143l3.99 7.95c.149.298.363.535.614.693V12.3a1.5 1.5 0 1 1 1.5 0v9.48c.251-.158.465-.395.615-.692l3.99-7.951c.481-.96.526-2.137.118-3.143l-1.016-2.505A1.75 1.75 0 0 0 18 5.75v-3a.75.75 0 0 0-1.5 0v3a.25.25 0 0 1-.25.25h-8.5a.25.25 0 0 1-.25-.25v-3z" fill="currentColor"></path></g></svg></span>
                <span class="link-text">&nbsp;文章</span>
            </div>
        </a>
        
        <a class="link-item " href="/categories/%e6%8a%80%e6%9c%af/">
            <div class="link-container">
                <span class="link-icon"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 16 16"><g fill="none"><path d="M11 1a4 4 0 0 0-3.896 4.91l-5.051 5.235a1.986 1.986 0 0 0 2.842 2.774l5.007-5.072a4.002 4.002 0 0 0 5.062-4.382a.5.5 0 0 0-.85-.287L12 6.293L9.707 4l2.115-2.115a.5.5 0 0 0-.287-.85A4.032 4.032 0 0 0 10.999 1z" fill="currentColor"></path></g></svg></span>
                <span class="link-text">&nbsp;技术</span>
            </div>
        </a>
        
        <a class="link-item " href="/categories/%E6%97%A5%E5%B8%B8/">
            <div class="link-container">
                <span class="link-icon"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24"><path d="M21.05 17.56l-17.97.94L3 17l17.98-.94l.07 1.5zM21 19.48H3v1.5h18v-1.5zM22 5v7c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V5c0-1.1.9-2 2-2h16c1.1 0 2 .9 2 2zm-2 1c-1.68 0-3.04.98-3.21 2.23c-.64-.73-2.73-2.73-6.54-2.73c-4.67 0-6.75 3-6.75 3s2.08 3 6.75 3c3.81 0 5.9-2 6.54-2.73C16.96 10.02 18.32 11 20 11V6z" fill="currentColor"></path></svg></span>
                <span class="link-text">&nbsp;日常</span>
            </div>
        </a>
        
        <a class="link-item " href="/links/">
            <div class="link-container">
                <span class="link-icon"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32"><path d="M29.25 6.76a6 6 0 0 0-8.5 0l1.42 1.42a4 4 0 1 1 5.67 5.67l-8 8a4 4 0 1 1-5.67-5.66l1.41-1.42l-1.41-1.42l-1.42 1.42a6 6 0 0 0 0 8.5A6 6 0 0 0 17 25a6 6 0 0 0 4.27-1.76l8-8a6 6 0 0 0-.02-8.48z" fill="currentColor"></path><path d="M4.19 24.82a4 4 0 0 1 0-5.67l8-8a4 4 0 0 1 5.67 0A3.94 3.94 0 0 1 19 14a4 4 0 0 1-1.17 2.85L15.71 19l1.42 1.42l2.12-2.12a6 6 0 0 0-8.51-8.51l-8 8a6 6 0 0 0 0 8.51A6 6 0 0 0 7 28a6.07 6.07 0 0 0 4.28-1.76l-1.42-1.42a4 4 0 0 1-5.67 0z" fill="currentColor"></path></svg></span>
                <span class="link-text">&nbsp;链接</span>
            </div>
        </a>
        
        <a class="link-item " href="/about/">
            <div class="link-container">
                <span class="link-icon"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32"><path d="M25 10l1.593 3l3.407.414l-2.5 2.253L28 19l-3-1.875L22 19l.5-3.333l-2.5-2.253L23.5 13l1.5-3z" fill="currentColor"></path><path d="M22 30h-2v-5a5.006 5.006 0 0 0-5-5H9a5.006 5.006 0 0 0-5 5v5H2v-5a7.008 7.008 0 0 1 7-7h6a7.008 7.008 0 0 1 7 7z" fill="currentColor"></path><path d="M12 4a5 5 0 1 1-5 5a5 5 0 0 1 5-5m0-2a7 7 0 1 0 7 7a7 7 0 0 0-7-7z" fill="currentColor"></path></svg></span>
                <span class="link-text">&nbsp;关于</span>
            </div>
        </a>
        
    </div>
    <div class="meta-info">
        <span class="show">Mozzie © 2025<br />Made With ♥</span>
        <span class="hide">Theme Candy 2 By <a href="https://github.com/Archeb/candy2-hugo">Candy2-Hugo</a></span>
    </div>
</div>
    <div id="contained-containers" class="contained-containers">
        <div class="contained-beans">
            
                        <a href="https://mozz.ie/posts/xiaomi-yu7-experience/" class="bean bean-article" style="background-image: url('/assets/Xiaomi-YU7-experience/image-20251204230236060.png');">
    <div class="article-category">
        <div class="category-item">
            <div class="item-text">2025年12月4日</div>
        </div>
        <div class="category-item">
            <div class="item-text">日常</div>
        </div>
    </div>
    <div class="article-title">
        <span>小米 YU7 三个月驾乘体验</span>
        <div class="article-summary">
            男人最快乐的事，大概就是在合适的年龄，买了那台不会后悔的车。
        </div>
    </div>
</a>
                        
                        <a href="https://mozz.ie/posts/wdm-custom-combo-boardband/" class="bean bean-article" style="background-image: url('/assets/wdm-custom-combo-boardband/xgspon3A_764X452.jpg');">
    <div class="article-category">
        <div class="category-item">
            <div class="item-text">2025年4月19日</div>
        </div>
        <div class="category-item">
            <div class="item-text">技术</div>
        </div>
    </div>
    <div class="article-title">
        <span>波分单线复用笑传之Custom Combo Broadband</span>
        <div class="article-summary">
            只要一个￥38的波分复用器，巧妙解决小区单线入户但想多运营商接入的老生常谈问题
        </div>
    </div>
</a>
                        
                        <a href="https://mozz.ie/posts/homeassistant-integration-writeup/" class="bean bean-article" style="background-image: url('/assets/homeassistant-integration-writeup/photo_2025-03-22_01-05-25.jpg');">
    <div class="article-category">
        <div class="category-item">
            <div class="item-text">2025年3月22日</div>
        </div>
        <div class="category-item">
            <div class="item-text">技术</div>
        </div>
    </div>
    <div class="article-title">
        <span>新柏石KNX协议智能家居网关接入 HomeAssistant</span>
        <div class="article-summary">
            只需要一根网线和一些小技巧，将开发商精装送的全屋智能设备接入HA，同时完整保留对原有系统的兼容，不具侵入性。
        </div>
    </div>
</a>
                        
                        <a href="https://mozz.ie/posts/dual-cgnat-routeros-wireguard-tunnel/" class="bean bean-article" style="background-image: url('/img/cover1.jpg');">
    <div class="article-category">
        <div class="category-item">
            <div class="item-text">2025年1月24日</div>
        </div>
        <div class="category-item">
            <div class="item-text">技术</div>
        </div>
    </div>
    <div class="article-title">
        <span>双方无公网状态下 RouterOS 基于 WireGuard 的组网方案</span>
        <div class="article-summary">
            双方无公网但其中一方是 Full Cone NAT，这种情况下如何用 RouterOS 组网？要解决这个问题，你需要一台 Linux（或者容器）来帮路由器打洞。
        </div>
    </div>
</a>
                        
                        <a href="https://mozz.ie/posts/gdcu-iptv-playlist/" class="bean bean-article" style="background-image: url('/img/cover1.jpg');">
    <div class="article-category">
        <div class="category-item">
            <div class="item-text">2024年10月27日</div>
        </div>
        <div class="category-item">
            <div class="item-text">技术</div>
        </div>
    </div>
    <div class="article-title">
        <span>广东联通 IPTV 鉴权&amp;抓源脚本（以及碎碎念）</span>
        <div class="article-summary">
            效果和用途同上一篇一样，只不过换成了联通的，两家的架构大差不差。至于我为什么从电信换成了联通，请看正文
        </div>
    </div>
</a>
                        
                        <a href="https://mozz.ie/posts/gdct-iptv-auth-and-fetch-playlist/" class="bean bean-article" style="background-image: url('/img/cover1.jpg');">
    <div class="article-category">
        <div class="category-item">
            <div class="item-text">2023年6月25日</div>
        </div>
        <div class="category-item">
            <div class="item-text">技术</div>
        </div>
    </div>
    <div class="article-title">
        <span>广东电信 IPTV 自助鉴权 &#43; 获取播放列表</span>
        <div class="article-summary">
            懒得每次失效都要重新抓包了，研究发现可以重放鉴权包，现在可以在电脑完成整个过程了
        </div>
    </div>
</a>
                        
                        <a href="https://mozz.ie/posts/why-not-pon-fttr/" class="bean bean-article" style="background-image: url('/assets/why-not-pon-fttr/large-20220408_banner_cms_webinar_ftth-rollout_760x428.jpg');">
    <div class="article-category">
        <div class="category-item">
            <div class="item-text">2023年5月7日</div>
        </div>
        <div class="category-item">
            <div class="item-text">技术</div>
        </div>
    </div>
    <div class="article-title">
        <span>为什么我们要拒绝 PON 方案的 FTTR</span>
        <div class="article-summary">
            “FTTR 是一套很神奇的几乎没有任何优点的方案。很少见到这样全是缺点几乎没优点的方案”
        </div>
    </div>
</a>
                        
                        <a href="https://mozz.ie/posts/turn-windows-11-into-server-2022/" class="bean bean-article" style="background-image: url('/assets/turn-windows-11-into-server-2022/Snipaste_2023-01-02_11-57-49.png');">
    <div class="article-category">
        <div class="category-item">
            <div class="item-text">2023年1月2日</div>
        </div>
        <div class="category-item">
            <div class="item-text">技术</div>
        </div>
    </div>
    <div class="article-title">
        <span>把 Windows 11/10 不完全转换为 Windows Server 2022</span>
        <div class="article-summary">
            当你想使用一些 Windows Server 专属功能的时候，你也许想要这么做。比如我打算用的 DDA （Discrete Device Assignment）功能。本文不涉及关于如何激活的内容，请自备许可证。
        </div>
    </div>
</a>
                        
                        <a href="https://mozz.ie/posts/usb-ecm-and-ipv6-for-openstick/" class="bean bean-article" style="background-image: url('/assets/usb-ecm-and-ipv6-for-openstick/photo_2022-10-04_18-29-37.jpg');">
    <div class="article-category">
        <div class="category-item">
            <div class="item-text">2022年10月5日</div>
        </div>
        <div class="category-item">
            <div class="item-text">日常</div>
        </div>
        <div class="category-item">
            <div class="item-text">技术</div>
        </div>
    </div>
    <div class="article-title">
        <span>高通410随身WiFi的进阶USB网络共享和IPv6配置</span>
        <div class="article-summary">
            主要包括 USB CDC-ECM 的配置以让它被 RouterOS 识别，还有基于 ND Proxy 的 IPv6 共享
        </div>
    </div>
</a>
                        
                        <a href="https://mozz.ie/posts/thinkbook-14-g4&#43;ara-amd-ryzen-hands-on/" class="bean bean-article" style="background-image: url('/assets/ThinkBook-14-G4&#43;ARA-AMD-Ryzen-Hands-On/image-20220802032903453.png');">
    <div class="article-category">
        <div class="category-item">
            <div class="item-text">2022年8月1日</div>
        </div>
        <div class="category-item">
            <div class="item-text">日常</div>
        </div>
        <div class="category-item">
            <div class="item-text">技术</div>
        </div>
    </div>
    <div class="article-title">
        <span>ThinkBook 14&#43; 锐龙版上手体验</span>
        <div class="article-summary">
            2022年，史称6800H年。
        </div>
    </div>
</a>
                        
                        <a href="https://mozz.ie/posts/experience-summary-for-arch-and-kde/" class="bean bean-article" style="background-image: url('/assets/8854314f89b9e34d7201c.png');">
    <div class="article-category">
        <div class="category-item">
            <div class="item-text">2022年6月27日</div>
        </div>
        <div class="category-item">
            <div class="item-text">日常</div>
        </div>
        <div class="category-item">
            <div class="item-text">技术</div>
        </div>
    </div>
    <div class="article-title">
        <span>ArchLinux &#43; KDE 一周使用小结</span>
        <div class="article-summary">
            蚊子の第二次 Linux 挑战，堂堂开幕！
        </div>
    </div>
</a>
                        
                        <a href="https://mozz.ie/posts/fix-fractional-scaling-edge-chrome-position/" class="bean bean-article" style="background-image: url('/assets/images/2021/11/----_gjs_20211127130445.png.webp');">
    <div class="article-category">
        <div class="category-item">
            <div class="item-text">2021年11月27日</div>
        </div>
        <div class="category-item">
            <div class="item-text">日常</div>
        </div>
        <div class="category-item">
            <div class="item-text">技术</div>
        </div>
        <div class="category-item">
            <div class="item-text">水</div>
        </div>
    </div>
    <div class="article-title">
        <span>修复 Edge/Chrome 在 GNOME 分数缩放下的窗口位置问题</span>
        <div class="article-summary">
            从上周开始，老莱弄了个“Daily Driver CHALLENGE”，然后我也跟了一波风
        </div>
    </div>
</a>
                        
                        <a href="https://mozz.ie/posts/extracting-iptv-live-streams/" class="bean bean-article" style="background-image: url('/img/cover1.jpg');">
    <div class="article-category">
        <div class="category-item">
            <div class="item-text">2021年4月12日</div>
        </div>
        <div class="category-item">
            <div class="item-text">日常</div>
        </div>
        <div class="category-item">
            <div class="item-text">网络</div>
        </div>
        <div class="category-item">
            <div class="item-text">技术</div>
        </div>
    </div>
    <div class="article-title">
        <span>轻松抓取并解析广东电信 IPTV 全部直播源</span>
        <div class="article-summary">
            老爸说想在卧室看电视，网上的电视直播软件大多都不怎么稳定，还有广告。而 GitHub 上的 IPTV 项目里的源清晰度也都不咋地。自己动手，丰衣足食，自己从机顶盒里抓吧！
        </div>
    </div>
</a>
                        
                        <a href="https://mozz.ie/posts/ultimate-virtual-monitor-solution-indirect-display/" class="bean bean-article" style="background-image: url('/assets/images/2021/04/----1.png.webp');">
    <div class="article-category">
        <div class="category-item">
            <div class="item-text">2021年4月11日</div>
        </div>
        <div class="category-item">
            <div class="item-text">技术</div>
        </div>
    </div>
    <div class="article-title">
        <span>虚拟显示器终极解决方案 IndirectDisplay</span>
        <div class="article-summary">
            自从上了大学，因为学校在珠海家在广州距离不算远，所以我经常两头跑。别人两头跑带个笔记本也就好了；我虽
        </div>
    </div>
</a>
                        
                        <a href="https://mozz.ie/posts/pve-based-home-network/" class="bean bean-article" style="background-image: url('/assets/images/size/w1000/2021/03/image.png.webp');">
    <div class="article-category">
        <div class="category-item">
            <div class="item-text">2021年3月6日</div>
        </div>
        <div class="category-item">
            <div class="item-text">技术</div>
        </div>
        <div class="category-item">
            <div class="item-text">网络</div>
        </div>
    </div>
    <div class="article-title">
        <span>基于PVE的新网络架构 - 踩坑回顾</span>
        <div class="article-summary">
            用 LXC 容器来跑 OpenWRT 虽然很香，但也有一些坑。
        </div>
    </div>
</a>
                        
                        <div class="bean-space"></div>
                    </div>
                </div>
            </div>

            
            <div class="modal"
                style="visibility: visible; background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(20px);">
                <div class="article-toc">
                    <nav id="TableOfContents">
  <ul>
    <li><a href="#外围探索">外围探索</a></li>
    <li><a href="#智能主机">智能主机</a></li>
    <li><a href="#深入底层">深入底层</a></li>
    <li><a href="#实现集成">实现集成</a></li>
  </ul>
</nav>
                </div>
                <div class="modal-visible-container">
                <div class="bean bean-read" style="transform: translate(0, 0);">
                    <div class="modal-close">×</div>
                    <div class="article-cover"
                        style="background-image: url('/assets/homeassistant-integration-writeup/photo_2025-03-22_01-05-25.jpg');">
                        <div></div>
                        <div class="article-title">
                            新柏石KNX协议智能家居网关接入 HomeAssistant
                            <div class="article-category">
                                
                                <div class="category-item">
                                    <div class="item-text">技术</div>
                                </div>
                                
                                
                            </div>
                        </div>
                    </div>
                    <div class="article-banner">
                        <div id="banner-progressbar"></div>
                        <div class="banner-content">
                            
                            <div class="banner-author">
                                
                                <div class="author-avatar">
                                    <img src="/img/icon.png" alt="mozzie">
                                </div>
                                
                                <span class="author-name">mozzie</span>
                                <span class="publish-time">2025年3月22日</span>
                                <span class="small-title">新柏石KNX协议智能家居网关接入 HomeAssistant</span>
                            </div>
                            <div class="banner-tools">
                                <span class="reading-time">阅读共需 1 分钟</span>
                            </div>
                        </div>
                        <div class="mobile-close-btn"><svg xmlns="http://www.w3.org/2000/svg"
                                xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32">
                                <path
                                    d="M24 9.4L22.6 8L16 14.6L9.4 8L8 9.4l6.6 6.6L8 22.6L9.4 24l6.6-6.6l6.6 6.6l1.4-1.4l-6.6-6.6L24 9.4z"
                                    fill="currentColor"></path>
                            </svg></div>
                    </div>
                    <div class="article-content">
                        <p>最近搬家，开发商的精装包括一套新柏石（NewBest）的智能家居系统，但是只能用开发商的App接入，这对我来说非常不能忍——控制自己家里的设备还要走一道互联网？所以我搬进来的 Day 1 就开始研究怎么把这些灯和空调之类的接到 HomeAssistant 里。最后前天晚上无意间发现的一个后台命令执行，终于打通了整个环节，让我得以通过自定义集成的方式将他接入内网的 HA。接下来就是整个过程。</p>
<p>在开始之前，我也尝试过在网络上搜索方案，不过这套方案似乎是完全 to B 的，网络上资料稀少。搜索开发商名字在抖音上倒是有一些结果，但是他们的方案是非常昂贵、麻烦而且具有侵入性（需要拆机接线）的，需要自己配KNX/IP Gateway。所以我一直想，能不能利用现有的设备直接接入HA。</p>
<h2 id="外围探索">外围探索</h2>
<p>首先观察这套全屋智能的控制设备，分别是客厅的一个主控面板，各个客房的分控面板，以及实体开关。主控面板根据观察是运行的 Android</p>
<p><img src="/assets/homeassistant-integration-writeup/image-20250322105212479.png" alt="image-20250322105212479"></p>
<p>系统设置中，网关连接、设备配置等不少选项都加密了，但是有一个拉起原生Settings的连接WiFi选项。从这里可以连接自己的WiFi，后续还发现这个面板默认5555端口开放，adb shell连上就是 root。但是最核心的这个面板本体APK被360加固了，拆壳过于麻烦，所以我先暂时放下，去观察其他设备。</p>
<p>接下来来到弱电箱，其中的核心设备就是题图里的这个“AI Mind”主机。</p>
<p><img src="/assets/homeassistant-integration-writeup/image-20250322110939122.png" alt="image-20250322110939122"></p>
<p>根据官网的描述，它通过KNX、RS485等总线协议控制灯、空调等设备，同时还具有丰富的对接和云控功能。在这里，我们主要关注的是他的这个RJ45网口。</p>
<p><img src="/assets/homeassistant-integration-writeup/image-20251006123903412.png" alt="image-20251006123903412"></p>
<h2 id="智能主机">智能主机</h2>
<p>在主机最顶部左侧找到RJ45网口，并将其连接到我们的局域网中，通过DHCP Leases分配可以看到他自动获取了IP。我们直接对这个主机进行端口扫描，可以发现开放了22、80等端口。现在打开浏览器访问其80端口，就是这个主机的后台管理系统。</p>
<p><img src="/assets/homeassistant-integration-writeup/image-20250322111744660.png" alt="image-20250322111744660"></p>
<p>通过观察 POST /login 这个请求以及一些简单的 F12 操作，我们来到了后台。</p>
<p><img src="/assets/homeassistant-integration-writeup/image-20250322111922414.png" alt="image-20250322111922414"></p>
<p>在后台我们可以配置各个区域以及下面的设备、场景、规则等</p>
<p><img src="/assets/homeassistant-integration-writeup/image-20250322112105912.png" alt="image-20250322112105912"></p>
<p>我们已经取得了一些进展，但目前仅仅是这样还不够。因为从前端分析，没有发现给我们任何控制这些设备的接口。接下来，让我们继续深入。</p>
<h2 id="深入底层">深入底层</h2>
<p>在这个面板的参数设置界面，有一个“启动本地KNX调试”的按钮。我们点击一下并观察其请求，让人感到十分甚至九分的亲切，仿佛已经到了家目录一样。</p>
<p><img src="/assets/homeassistant-integration-writeup/image-20250322112542231.png" alt="image-20250322112542231"></p>
<p>系统里的curl可以用，也有完整bash。但是最简单的办法就是读一下 <code>/etc/shadow</code> 然后拿着密码连上 ssh。</p>
<p><img src="/assets/homeassistant-integration-writeup/image-20250322114608443.png" alt="image-20250322114608443"></p>
<p>观察 netstat 可以发现这个主机的 Web 服务就是由 <code>SmartHome-Controller-1.0-SNAPSHOT-fat.jar</code> 提供的，让我们读一下它的代码。</p>
<p>搜索相关关键字可以找到，<code>/ntesec/controller/web/handler/v01</code> 里面的代码就是这些 API 的处理逻辑，对我们有用的主要是这两个方法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>getRouter().<span style="color:#a6e22e">route</span>().<span style="color:#a6e22e">path</span>(<span style="color:#e6db74">&#34;/getDeviceStatus&#34;</span>).<span style="color:#a6e22e">method</span>(HttpMethod.<span style="color:#a6e22e">GET</span>).<span style="color:#a6e22e">handler</span>(CtrlHomeREST::getDeviceStatus);
</span></span><span style="display:flex;"><span>getRouter().<span style="color:#a6e22e">route</span>().<span style="color:#a6e22e">path</span>(<span style="color:#e6db74">&#34;/sendKNX&#34;</span>).<span style="color:#a6e22e">method</span>(HttpMethod.<span style="color:#a6e22e">GET</span>).<span style="color:#a6e22e">handler</span>(CtrlHomeREST::sendKNX);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">sendKNX</span>(RoutingContext routingContext) {
</span></span><span style="display:flex;"><span>  String realAddr <span style="color:#f92672">=</span> routingContext.<span style="color:#a6e22e">request</span>().<span style="color:#a6e22e">getParam</span>(<span style="color:#e6db74">&#34;realAddr&#34;</span>);
</span></span><span style="display:flex;"><span>  String value <span style="color:#f92672">=</span> routingContext.<span style="color:#a6e22e">request</span>().<span style="color:#a6e22e">getParam</span>(<span style="color:#e6db74">&#34;value&#34;</span>);
</span></span><span style="display:flex;"><span>  String length <span style="color:#f92672">=</span> routingContext.<span style="color:#a6e22e">request</span>().<span style="color:#a6e22e">getParam</span>(<span style="color:#e6db74">&#34;length&#34;</span>);
</span></span><span style="display:flex;"><span>  EventBus eb <span style="color:#f92672">=</span> routingContext.<span style="color:#a6e22e">vertx</span>().<span style="color:#a6e22e">eventBus</span>();
</span></span><span style="display:flex;"><span>  JsonObject jsonObject <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> JsonObject();
</span></span><span style="display:flex;"><span>  jsonObject.<span style="color:#a6e22e">put</span>(<span style="color:#e6db74">&#34;realAddr&#34;</span>, realAddr);
</span></span><span style="display:flex;"><span>  jsonObject.<span style="color:#a6e22e">put</span>(<span style="color:#e6db74">&#34;value&#34;</span>, value);
</span></span><span style="display:flex;"><span>  jsonObject.<span style="color:#a6e22e">put</span>(<span style="color:#e6db74">&#34;length&#34;</span>, Integer.<span style="color:#a6e22e">valueOf</span>(length));
</span></span><span style="display:flex;"><span>  eb.<span style="color:#a6e22e">send</span>(<span style="color:#e6db74">&#34;ntesec.controller.executor.writeRealAddrKNX&#34;</span>, jsonObject);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">getDeviceStatus</span>(RoutingContext routingContext) {
</span></span><span style="display:flex;"><span>  String deviceIds <span style="color:#f92672">=</span> routingContext.<span style="color:#a6e22e">request</span>().<span style="color:#a6e22e">getParam</span>(<span style="color:#e6db74">&#34;deviceIds&#34;</span>);
</span></span><span style="display:flex;"><span>  log.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;收到查询设备当前状态请求：deviceIds=》&#34;</span> <span style="color:#f92672">+</span> deviceIds);
</span></span><span style="display:flex;"><span>  Vertx vertx <span style="color:#f92672">=</span> routingContext.<span style="color:#a6e22e">vertx</span>();
</span></span><span style="display:flex;"><span>  EventBus eb <span style="color:#f92672">=</span> vertx.<span style="color:#a6e22e">eventBus</span>();
</span></span><span style="display:flex;"><span>  VertxFormLoginHandlerImpl.<span style="color:#a6e22e">isOnline</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (StringUtil.<span style="color:#a6e22e">isNullOrEmpty</span>(deviceIds)) {
</span></span><span style="display:flex;"><span>    log.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;返回当前所有设备状态&#34;</span> <span style="color:#f92672">+</span> GlobalData.<span style="color:#a6e22e">statusMap</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    RespUtil.<span style="color:#a6e22e">writeJsonLmx</span>(<span style="color:#e6db74">&#34;success&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>, GlobalData.<span style="color:#a6e22e">statusMap</span>, routingContext);
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    String<span style="color:#f92672">[]</span> ids <span style="color:#f92672">=</span> deviceIds.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#34;,&#34;</span>);
</span></span><span style="display:flex;"><span>    Map<span style="color:#f92672">&lt;</span>Integer, JsonObject<span style="color:#f92672">&gt;</span> tmp <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (String id : ids) {
</span></span><span style="display:flex;"><span>      tmp.<span style="color:#a6e22e">put</span>(Integer.<span style="color:#a6e22e">valueOf</span>(id), (JsonObject)GlobalData.<span style="color:#a6e22e">statusMap</span>.<span style="color:#a6e22e">get</span>(Integer.<span style="color:#a6e22e">valueOf</span>(id)));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    log.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;返回查询设备状态&#34;</span> <span style="color:#f92672">+</span> tmp);
</span></span><span style="display:flex;"><span>    RespUtil.<span style="color:#a6e22e">writeJsonLmx</span>(<span style="color:#e6db74">&#34;success&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>, tmp, routingContext);
</span></span><span style="display:flex;"><span>  } 
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>有了这些方法，就可以写入KNX总线信息和读取状态，足以实现一个 HomeAssistant Custom Component 了。</p>
<blockquote>
<p>我：真是一点鉴权没做啊</p>
<p>群友：这个叫做方便用户二次开发</p>
</blockquote>
<h2 id="实现集成">实现集成</h2>
<p>接下来的工作由 Cursor 和 Claude 酱完成~ 我们只需要把接口定义和数据结构告诉她，然后她就会给我们写出一个自定义集成了。当然还需要一些调试，但是 Cursor 真的百倍地提升了工作效率，只花了两个小时就全部搞定了。</p>
<p><img src="/assets/homeassistant-integration-writeup/image-20250322115732767.png" alt="image-20250322115732767"></p>
<p>通过 HA 的集成能力，我们可以把这些设备接入到 HomeKit 或者小爱同学里面，也可以继续购买新的设备与它们联动，无限拓宽了这个原本封闭的开发商智能家居生态。</p>
<blockquote>
<p>47：你群都是日日再用，不日能用？</p>
</blockquote>

                    </div>
                    
                </div>
                    
                    
                        <div class="bean article-comment article-comment-hidden">
                            <div class="comment-container">
                            <div id="gitalk-container"></div>
<script>
var href = new URL(window.location.href).pathname.split("/");
var slug = href[href.length - 1] != "" ? href[href.length - 1] : href[href.length - 2]
new Gitalk({
  clientID: "fb4a07f44c3d7b079399",
  clientSecret: "08adb9b8b4da92a812adb7257412c9efff4f92f4",
  repo: "Blog-Comments",
  owner: "Archeb",
  admin: ["Archeb"],
  proxy: "https://corsproxy.gfw.moe/corsproxy/?apiurl=https://github.com/login/oauth/access_token",
  id: slug, 
  distractionFreeMode: false, 
}).render('gitalk-container')
</script>

                            </div>
                        </div>
                    
                </div>
                <div class="bean-tools">
                    <div class="tool-btn" id="btn-top" title="回到顶部"
                        onclick="document.querySelector('.bean-read').scrollTo({top: 0, behavior: 'smooth'})">
                        <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="24" height="24">
                            <path
                                d="M519.4 242.8l263.8 333.4c14.6 18.4 1.4 45.8-22.2 45.8H263c-23.6 0-36.8-27.4-22.2-45.8l263.8-333.4c10.4-13.2 30.4-13.2 40.8 0z"
                                fill="currentColor" />
                        </svg>
                    </div>
                    
                    <div class="tool-btn" id="btn-comment" title="查看评论"
                        onclick="toggleComments()">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="24" height="24">
                            <path
                                d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2ZM20 16H6L4 18V4H20V16Z"
                                fill="currentColor" />
                        </svg>
                    </div>
                    
                    <div class="tool-btn" id="btn-share" title="分享"
                        onclick="navigator.share({title: document.title, url: window.location.href})">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="24" height="24">
                            <path
                                d="M18 16.08C17.24 16.08 16.56 16.38 16.04 16.85L8.91 12.7C8.96 12.47 9 12.24 9 12C9 11.76 8.96 11.53 8.91 11.3L15.96 7.19C16.5 7.69 17.21 8 18 8C19.66 8 21 6.66 21 5C21 3.34 19.66 2 18 2C16.34 2 15 3.34 15 5C15 5.24 15.04 5.47 15.09 5.7L8.04 9.81C7.5 9.31 6.79 9 6 9C4.34 9 3 10.34 3 12C3 13.66 4.34 15 6 15C6.79 15 7.5 14.69 8.04 14.19L15.16 18.34C15.11 18.55 15.08 18.77 15.08 19C15.08 20.61 16.39 21.92 18 21.92C19.61 21.92 20.92 20.61 20.92 19C20.92 17.39 19.61 16.08 18 16.08Z"
                                fill="currentColor" />
                        </svg>
                    </div>
                </div>
            </div>
            
    <script src="/js/candy2.js"></script>
</body>

</html>